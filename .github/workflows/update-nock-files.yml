name: Update Nock files

on:
  workflow_dispatch:
    inputs:
      pr_id:
        description: PR ID
        type: number
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        ref: refs/pull/${{ inputs.pr_id }}/head

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          # Let's use the oldest version supported to be sure the V8
          # serialization is compatible with all supported versions.
          node-version: 14.x

      - name: Get the Yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(corepack yarn config get cacheFolder)"

      - uses: actions/cache@v3
        with:
          path: ${{steps.yarn-cache-dir-path.outputs.dir}}
          key: ${{runner.os}}-yarn-${{hashFiles('**/yarn.lock')}}
          restore-keys: |
            ${{runner.os}}-yarn-

      - run: corepack yarn install --immutable
      - run: corepack yarn build # We need the stubs to run the tests

      - name: Remove old Nock files to avoid conflicts
        run: rm -r tests/nock

      - run: corepack yarn test
        env:
          NOCK_ENV: record

      - name: Check if anything has changed
        id: contains-changes
        run: echo "::set-output name=result::$(git --no-pager diff --quiet || echo "yes")"

      - name: Commit changes
        if: steps.contains-changes.outputs.result == "yes"
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git commit -A -m "update Nock files"

      - name: Push changes
        if: steps.contains-changes.outputs.result == "yes"
        run: git push origin HEAD:refs/pull/${{ inputs.pr_id }}/head

      - name: Upload `tests/nock` in case of failure
        uses: actions/upload-artifact@v3
        if: failure() && steps.contains-changes.outputs.result == "yes"
        with:
          name: nock
          path: |
            tests/nock
